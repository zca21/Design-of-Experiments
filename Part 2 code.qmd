---
title: "Design of Experiments Coursework-34273638"
format: html
editor: visual
---

## Part 2

```{r}
#Setting up enviroment
library(tidyverse)
exercise <- data.frame(
 Subject = rep(1:3, rep(4, 3)),
 Day = rep(1:4, 3),
 Treatment = c(1, 4, 3, 2, 2, 1, 4, 3, 3, 2, 1, 4),
 Y = c(45, 27, 27, 15, 18, 32, 23, 15, 23, 16, 28, 20)
)

exercise <- exercise%>%
  mutate(Subject = factor(Subject,levels = c(1:3),labels=c(1:3)),
         Day = factor(Day, levels=c(1:4), labels=c(1:4)),
         Treatment = factor(Treatment, levels=c(1:4),labels=c(1:4)))

head(exercise)
```

Investigating differences:

```{r}
aggregate(Y~Treatment,data=exercise,
          FUN = function(x) c(mean = mean(x), sd = sd(x)))
aggregate(Y~Subject,data=exercise,
          FUN = function(x) c(mean = mean(x), sd = sd(x)))
aggregate(Y~Day,data=exercise,
          FUN = function(x) c(mean = mean(x), sd = sd(x)))
#aggregate(Y~Subject,data=exercise,FUN = mean)
#aggregate(Y~Day,data=exercise,FUN = mean)

#plots
boxplot(Y ~ Treatment,data=exercise)
boxplot(Y ~ Subject,data=exercise)
boxplot(Y ~ Day,data=exercise)
```

The unit block treatment model is defined below:

$y_{ijk} = \mu + \alpha_{i} + \beta_{j} + \tau_{k} + \epsilon_{ijk}, \; \: \: i,k=\{1,2,3,4\}, \; \; j=\{1,2,3\}$

Here the model has constant parameter $\mu$, $\alpha_{i}$ the blocking effect from day, $\beta_{j}$ the blocking effect from subject, $\tau_{k}$ the treatment effects and the error $\epsilon_{ijk} \sim N(0,\sigma^{2})$ and independent.

```{r}
#creating model
exercise.lm <- lm(Y ~ Day+Subject+Treatment,data=exercise)
anova(exercise.lm)
```

The treatment line of the ANOVA test compares models with and without the effects of treatment by testing $H_{0}: \tau_{1}=\tau_{2}=\tau_{3}=\tau_{4}=0$ vs $H_{1}:\tau_{w} \ne \tau_{r} \: \:\text{for} \: \: w \ne r$ with both models still including the blocking factors Day and Subject. We get a significant p-value of 0.03012, thus we reject $H_{0}$ that there is no treatment difference at the 5% level indicating there is a significant effect of Treatment. COMMENT ON THE BLOCKING EFFECTS.

Estimating all pairwise differences.

```{r}
#Investigating pairwise differences
exercise.emm <- emmeans::emmeans(exercise.lm, ~ Treatment)
pairs(exercise.emm)
```

Only the comparison between treatment 1 and 2 is significant at the 5% level with a p-value of 0.0252 after adjustment of multiple comparisons using Tukey.

```{r}
#residual plots
standres <- rstandard(exercise.lm)
fitted <- fitted(exercise.lm)
par(mfrow = c(1, 2), pty = "s")
with(exercise, {
  plot(Subject, standres, xlab = "Subject", ylab = "Standarised residuals")
  plot(Day, standres, xlab = "Day", ylab = "Standarised residuals")
 par(mfrow = c(1, 2), pty = "s") 
  plot(fitted, standres, xlab = "Fitted value", ylab = "Standarised residuals")
})

par(pty = "s")
qqnorm(standres, main = "")

```

The plots show no large residual values with absolute values greater than 2 (which would indicate poor fit of the model). There is some evidence of unequal variation (in particular subjects' 2 variation is much lower than that of subjects 1 and 3). However, there is no obvious patterns with respect to the fitted values against the standardised residuals with a random scattering of points in the plot. Finally, the points of the qqplot lie on a straight line which suggested the normality assumption is valid.

### Part B

```{r}
#Adding variables of two level factors
exercise <- exercise%>%
  mutate(Duration=ifelse(Treatment==1,1,ifelse(Treatment==2,1,3)),
         Speed=ifelse(Treatment==1,40,ifelse(Treatment==3,40,60)),
         Pedal=ifelse(Treatment==1,"hand",ifelse(Treatment==4,"hand","foot")),
         Duration= factor(Duration,levels=c(1,3),labels=c(1,3)),
         Speed=factor(Speed,levels=c(40,60),labels=c(40,60)),
         Pedal=factor(Pedal,levels=c("hand","foot"),labels=c("hand","foot")))

exercise_contrast <- exercise%>%
  mutate(Duration = ifelse(Duration==1,-1,1),
         Speed = ifelse(Speed==40,-1,1),
         Pedal = ifelse(Pedal=="hand",-1,1))
```


```{r}
#note can't include interations due to not observations
fact.lm <- lm(Y ~ Subject + Day + Duration +Speed + Pedal, data = exercise_contrast)
anova(fact.lm)

# #testing against models without factor (same as the anova test above but just doing explictly)
# 
# fact.lm.1 <- lm(Y ~ Subject + Day + Speed + Pedal, data = exercise_contrast)
# fact.lm.2 <- lm(Y ~ Subject + Day + Duration + Pedal, data = exercise_contrast)
# fact.lm.3 <- lm(Y ~ Subject + Day + Duration + Speed, data = exercise_contrast)
# 
# anova(fact.lm, fact.lm.1)
# anova(fact.lm, fact.lm.2)
# anova(fact.lm, fact.lm.3)


 # exercise.2.emm <- emmeans::emmeans(fact.lm, ~ Speed+Duration)
 # pairs(exercise.2.emm)
```

Adding the new factorial treatment effects gives the updated regression model below, 
CHECK THIS IS ACTUALLY ALRIGHT!
$y_{ijk} = \mu + \alpha_{i} + \beta_{j} + \tau_{k_{1}}^{S} + \tau_{k_{2}}^{D} + \tau_{k_{3}}^{P} + \epsilon_{ijk}, \; \: \: k_{w}=\{1,2\}, \;\;\; w = \{1,2,3\} \; \; j=\{1,2,3\}$

In the model I define Duration=1, Speed=40 and Pedal=hand as the low level of the two-level factors and Duration=3, Speed=60 and Pedal=foot as the high level. Again the error is independent and identically distributed with constant variance $\sigma^{2}$.

Using an ANOVA test after fitting this model, both Speed and Pedal factorial effects were found to be significantly different from 0 with p-values of 0.03738 and 0.01376 respectively. 
This makes intuitive sense as in part a we found that the only significant pairwise difference was between treatment 1 and 2 which by both their speed and pedal factorial level (Treatment 1 has both set to low, meanwhile Treatment 2 has them both set to high). Thus, we would expect for speed and pedal to be significant as the difference between treatment 1 and 2 was. SURELY WE CAN SAY MORE ON THIS???


```{r}
fact.npedal.lm <- lm(Y ~Subject + Day + Duration+Speed+Duration:Speed, data = exercise_contrast)
coef(fact.npedal.lm)

fact.nspeed.lm <- lm(Y ~Subject + Day + Duration+Pedal+Duration:Pedal, data = exercise_contrast)
coef(fact.nspeed.lm)

fact.nduration.lm <- lm(Y ~Subject + Day + Pedal+Speed+Pedal:Speed, data = exercise_contrast)
coef(fact.nduration.lm)
```

Due to the design not all possible combinations of the levels of the factor are present as a full factorial design would have $2^{3}=8$ different treatments instead of 4 (for example no test was done for the treatment combination of duration and speed set to low and pedal set to high). This means that we cannot investigate two-factor interactions using the dataset as the two-factor interactions cannot be separated from the third factorial effect. For example when investiagting the interaction between Duration and Speed, for Duration set to low when speed varies from its low to high level so does pedal and when Duration is set to its high level when speed varies from low to high pedal varies from high to low, thus any differences found could be due to Pedal varying and not an interaction effect between Speed and Duration (could instead be the interaction between Duration and Pedal that is causing the effect). Thus, the interaction term is confounded (SHOULD MENTION WHAT BY). To estimate the two-factor interaction we would instead need to assume the third factor has no effect on the response. Doing this means we remove this third factor from the model and thus our model becomes the blocking effects and the 2 factorial main effects and the interaction between.

Performing this for each combination of 2 factors gives the estimated coefficients for the two-factor interactions of 5.1875, 3.5625 and 0.75 for Duration:Speed, Duration:Pedal and Speed Pedal:Speed respectively. IS THIS ACTUALLY MATHEMATICALLY VIABLE?? ALSO SHOULD MENTION WHEN AT HIGH LEVEL? 

```{r}
## Extra stuff :P

#following code from section 5
X <- model.matrix( ~ Subject + Day + (Duration+Speed+Pedal)^3, data = exercise_contrast)
#note that there are 12 different blocks (3*4=12) and each one occurs once

#Defined hand as the low level, speed=40 as low level and duration=1 as low level
#all low levels of factor coded as -1 and all high levels as +1
main_effect_contrasts <- matrix(c(-1,-1,-1,
                                  1,1,-1,
                                  1,-1,1,
                                  -1,1,1,
                                  -1,1,1,
                                  -1,-1,-1,
                                  1,1,-1,
                                  1,-1,1,
                                  1,-1,1,
                                  -1,1,1,
                                  -1,-1,-1,
                                  1,1,-1)/6,c(12,3),byrow=T)
#Each column is the main effect contrast for duration, speed and pedal respectively

t(as.matrix(main_effect_contrasts)) %*% exercise$Y
```

Averaging the main effects over the blocking factors. The response decreases at the higher duration of 3 minutes by 3.167 compared to the lower duration of 1 minute. The response decreases at the higher speed of 60 rpm by 8.5 compared to the lower speed of 40 rpm. The response decreases when using the foot pedal by 10.167 compared to using the hand pedals.
